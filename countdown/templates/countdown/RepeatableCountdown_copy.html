<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'countdown/style/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'countdown/style/repeatablecountdown_style.css' %}">
</head>
<body>
    <header>
        <h1>Event Counter</h1>
        <div class="menu">
            <ul>
                <li><a href="/">Home</a></li>
            </ul>
        </div>
    </header>
    <main>
        {% if repeatableevent %}
            <div id="counting"></div>

        {% else %}
            <h1>This event doesn't exist.</h1>
        {% endif %}
    <a href="{% url 'countdown:index' %}"><button class="GoTo">Other countdowns</button></a>
        <script>
// Get the countdown element by its ID
let count_div = document.getElementById('counting');

const event_time_period= "{{ repeatableevent.event_time }}".split(" ")[1];
let event_time_unprocessed = "{{ repeatableevent.event_time }}".split(" ")[0].split(":");

if(event_time_period === "p.m."){
    event_time_unprocessed[0] = parseInt(event_time_unprocessed[0]) + 12 + ""
}
let event_time = event_time_unprocessed[0] + ":" + event_time_unprocessed[1] + ":"
    + event_time_unprocessed[2]
event_time = event_time.split(":");
const eventHours = parseInt(event_time[0]);
const eventMinutes = parseInt((event_time[1]!== "undefined") ? event_time[1] : "00");
const eventSeconds = parseInt((event_time[2]!== "undefined") ? event_time[2] : "00");

// Define a function to update the countdown
function updateCountdown() {
    let nextEventDayDate;
    const currentDate = new Date();

    // Create a date for the next event day
    {% if repeatableevent.event_day_of_week and repeatableevent.event_day_of_month %}
        nextEventDayDate = getDateOfClosestDayOfMonthAndWeek()
    {% elif repeatableevent.event_day_of_week %}
        nextEventDayDate = getDateOfClosestDayOfWeek(parseInt({{ repeatableevent.event_day_of_week }}), event_time);
    {% elif repeatableevent.event_day_of_month %}
        nextEventDayDate = new Date()
        nextEventDayDate.setFullYear(currentDate.getFullYear(), currentDate.getMonth() + 1, parseInt({{ repeatableevent.event_day_of_month }}))
    {% else %}
        document.write("Exception occurred! Check if you have entered day of week or day of month in admin form.")
    {% endif %}

    // Set the event time on the next event day
    nextEventDayDate.setHours(eventHours, eventMinutes, eventSeconds);

    // Calculate the time remaining until the event
    const timeRemaining = nextEventDayDate - currentDate;
    // Calculate days, hours, minutes, and seconds remaining
    const daysRemaining = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
    const hoursRemaining = Math.floor(timeRemaining % (1000 * 60 * 60 * 24) / (1000 * 60 * 60));
    const minutesRemaining = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
    const secondsRemaining = Math.floor((timeRemaining % (1000 * 60)) / 1000);

    // Update the countdown display
    count_div.innerHTML = `<h2>{{ repeatableevent.event_name }}</h2> will be in<br><div class="upper"><div class="box">${daysRemaining} days</div></div><br><div class="lower"><div class="box">${format_time(hoursRemaining)}</div>:<div class="box">${format_time(minutesRemaining)}</div>:<div class="box">${format_time(secondsRemaining)}</div></div>`;
}

// Call the updateCountdown function initially
updateCountdown();

// Update the countdown every second (1000 milliseconds)
setInterval(updateCountdown, 1000);

// Function to get the date of the closest day of the week
function getDateOfClosestDayOfWeek(targetDay, event_time) {
    const currentDate = new Date();
    const currentDay = currentDate.getDay();
    currentDate.getHours();
    let daysUntilTarget = (targetDay - currentDay + 7) % 7;
    const eventHours = parseInt(event_time[0]);
    const eventMinutes = parseInt((event_time[1]!== "undefined") ? event_time[1] : "00");
    const eventSeconds = parseInt((event_time[2]!== "undefined") ? event_time[2] : "00");
    if (daysUntilTarget === 0){
        if(eventHours <= currentDate.getHours()
            || eventMinutes <= currentDate.getMinutes()
            || eventSeconds <= currentDate.getSeconds()){
            daysUntilTarget += 7
        }
     }
    currentDate.setDate(currentDate.getDate() + daysUntilTarget);
    return currentDate;
}

// function add zero before hours, minutes, seconds if they are lower than 10 to make time look like this "04:02:07"
function format_time(timeComponent) {
    return (timeComponent < 10) ? "0" + timeComponent : timeComponent;
}


function getDateOfClosestDayOfMonthAndWeek(targetDayOfWeek, targetDayOfMonth) {
  const currentDate = new Date();
  const currentYear = currentDate.getFullYear();
  const currentMonth = currentDate.getMonth();
  const currentDay = currentDate.getDate();
  const currentDayOfWeek = currentDate.getDay();

  // Calculate the days until the target day of the week
  const daysUntilTarget = (targetDayOfWeek - currentDayOfWeek + 7) % 7;

  // Calculate the days until the target day of the month
  let daysUntilTargetDayOfMonth = targetDayOfMonth - currentDay;
  if (daysUntilTargetDayOfMonth < 0) {
    daysUntilTargetDayOfMonth += new Date(currentYear, currentMonth + 1, 0).getDate();
  }

  // Combine both calculations to find the next occurrence
  const totalDaysUntilTarget = daysUntilTarget + daysUntilTargetDayOfMonth;

  // Set the date to the next occurrence
  currentDate.setDate(currentDay + totalDaysUntilTarget);

  return currentDate;
}
        </script>
    </main>
    <footer>
        &copy; 2023 Tomasz Caba
    </footer>
</body>
</html>